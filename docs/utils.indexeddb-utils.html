<!DOCTYPE html>

<html>
<head>
  <title>#</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="collections.forms.html">
                collections.forms.coffee
              </a>
            
              
              <a class="source" href="collections.pages.html">
                collections.pages.coffee
              </a>
            
              
              <a class="source" href="main.html">
                main.coffee
              </a>
            
              
              <a class="source" href="models.database.html">
                models.database.coffee
              </a>
            
              
              <a class="source" href="models.file.html">
                models.file.coffee
              </a>
            
              
              <a class="source" href="models.form.html">
                models.form.coffee
              </a>
            
              
              <a class="source" href="models.page.html">
                models.page.coffee
              </a>
            
              
              <a class="source" href="routes.router.html">
                routes.router.coffee
              </a>
            
              
              <a class="source" href="test.collections.forms.spec.html">
                test.collections.forms.spec.coffee
              </a>
            
              
              <a class="source" href="test.collections.pages.spec.html">
                test.collections.pages.spec.coffee
              </a>
            
              
              <a class="source" href="test.models.file.spec.html">
                test.models.file.spec.coffee
              </a>
            
              
              <a class="source" href="test.models.form.spec.html">
                test.models.form.spec.coffee
              </a>
            
              
              <a class="source" href="test.models.page.spec.html">
                test.models.page.spec.coffee
              </a>
            
              
              <a class="source" href="test.routers.router.spec.html">
                test.routers.router.spec.coffee
              </a>
            
              
              <a class="source" href="test.spec.test.html">
                test.spec.test.coffee
              </a>
            
              
              <a class="source" href="test.specrunner.html">
                test.specrunner.coffee
              </a>
            
              
              <a class="source" href="test.utils.indexeddb-utils.spec.html">
                test.utils.indexeddb-utils.spec.coffee
              </a>
            
              
              <a class="source" href="test.views.app.spec.html">
                test.views.app.spec.coffee
              </a>
            
              
              <a class="source" href="test.views.basepage.spec.html">
                test.views.basepage.spec.coffee
              </a>
            
              
              <a class="source" href="test.views.form-add.spec.html">
                test.views.form-add.spec.coffee
              </a>
            
              
              <a class="source" href="test.views.form.spec.html">
                test.views.form.spec.coffee
              </a>
            
              
              <a class="source" href="test.views.forms-browse.spec.html">
                test.views.forms-browse.spec.coffee
              </a>
            
              
              <a class="source" href="test.views.mainmenu.spec.html">
                test.views.mainmenu.spec.coffee
              </a>
            
              
              <a class="source" href="test.views.page.spec.html">
                test.views.page.spec.coffee
              </a>
            
              
              <a class="source" href="test.views.pages.spec.html">
                test.views.pages.spec.coffee
              </a>
            
              
              <a class="source" href="utils.indexeddb-utils.html">
                utils.indexeddb-utils.coffee
              </a>
            
              
              <a class="source" href="views.app.html">
                views.app.coffee
              </a>
            
              
              <a class="source" href="views.basepage.html">
                views.basepage.coffee
              </a>
            
              
              <a class="source" href="views.form-add.html">
                views.form-add.coffee
              </a>
            
              
              <a class="source" href="views.form.html">
                views.form.coffee
              </a>
            
              
              <a class="source" href="views.forms-browse.html">
                views.forms-browse.coffee
              </a>
            
              
              <a class="source" href="views.mainmenu.html">
                views.mainmenu.coffee
              </a>
            
              
              <a class="source" href="views.page.html">
                views.page.coffee
              </a>
            
              
              <a class="source" href="views.pages.html">
                views.pages.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="-">#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>  Functionality <span class="hljs-keyword">for</span> interacting <span class="hljs-reserved">with</span> IndexedDB.

  Based heavily upon Matt West<span class="hljs-string">'s IndexedDB example todo application:

      http://blog.teamtreehouse.com/create-your-own-to-do-app-with-html5-and-indexeddb

  Defines a LingSyncIDB class that simplifies IndexedDB interactions.

</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h1 id="-">#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>
define <span class="hljs-function"><span class="hljs-params">(<span class="hljs-built_in">require</span>)</span> -&gt;</span>

  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LingSyncIDB</span></span>

    <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@id</span>, <span class="hljs-property">@version</span>)</span> -&gt;</span>
      <span class="hljs-property">@indexedDB</span> = <span class="hljs-built_in">window</span>.indexedDB <span class="hljs-keyword">or</span> <span class="hljs-built_in">window</span>.webkitIndexedDB <span class="hljs-keyword">or</span> \
        <span class="hljs-built_in">window</span>.mozIndexedDB <span class="hljs-keyword">or</span> <span class="hljs-built_in">window</span>.msIndexedDB
      <span class="hljs-property">@datastore</span> = <span class="hljs-literal">null</span>

    <span class="hljs-attribute">s4</span>:<span class="hljs-function"> -&gt;</span>
      (((<span class="hljs-number">1</span> + Math.random()) * <span class="hljs-number">0x10000</span>) | <span class="hljs-number">0</span>).toString(<span class="hljs-number">16</span>).substring <span class="hljs-number">1</span>

    <span class="hljs-attribute">guid</span>:<span class="hljs-function"> -&gt;</span>
      <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@s4</span>()}</span><span class="hljs-subst">#{<span class="hljs-property">@s4</span>()}</span>-<span class="hljs-subst">#{<span class="hljs-property">@s4</span>()}</span>-<span class="hljs-subst">#{<span class="hljs-property">@s4</span>()}</span>-<span class="hljs-subst">#{<span class="hljs-property">@s4</span>()}</span>-<span class="hljs-subst">#{<span class="hljs-property">@s4</span>()}</span><span class="hljs-subst">#{<span class="hljs-property">@s4</span>()}</span><span class="hljs-subst">#{<span class="hljs-property">@s4</span>()}</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Open a connection to the datastore</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">open</span>: <span class="hljs-function"><span class="hljs-params">(callback)</span> -&gt;</span>
      request = <span class="hljs-property">@indexedDB</span>.open <span class="hljs-property">@id</span>, <span class="hljs-property">@version</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Handle datastore upgrades.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      request.<span class="hljs-function"><span class="hljs-title">onupgradeneeded</span> = <span class="hljs-params">(e)</span> -&gt;</span>
        db = e.target.result
        e.target.transaction.onerror = <span class="hljs-property">@onerror</span>
        <span class="hljs-keyword">if</span> db.objectStoreNames.contains <span class="hljs-string">'forms'</span>
          db.deleteObjectStore <span class="hljs-string">'forms'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>store = db.createObjectStore ‘forms’, keyPath: ‘timestamp’</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        store = db.createObjectStore <span class="hljs-string">'forms'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Handle successful datastore access.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      request.<span class="hljs-function"><span class="hljs-title">onsuccess</span> = <span class="hljs-params">(e)</span> =&gt;</span>
        <span class="hljs-property">@datastore</span> = e.target.result
        callback()</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Handle errors when opening the datastore.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      request.<span class="hljs-function"><span class="hljs-title">onerror</span> = -&gt;</span>
        callback <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Fetch all of the form items in the datastore.
  @param {function} callback A function that will be executed once the items
  have been retrieved. Will be passed a param with an array of the form
  items.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">fetchForms</span>: <span class="hljs-function"><span class="hljs-params">(callback)</span> -&gt;</span>
      db = <span class="hljs-property">@datastore</span>
      transaction = db.transaction [<span class="hljs-string">'forms'</span>], <span class="hljs-string">'readwrite'</span>
      objStore = transaction.objectStore <span class="hljs-string">'forms'</span>
      keyRange = IDBKeyRange.lowerBound <span class="hljs-number">0</span>
      cursorRequest = objStore.openCursor keyRange
      forms = []

      transaction.<span class="hljs-function"><span class="hljs-title">oncomplete</span> = <span class="hljs-params">(e)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Execute the callback function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        callback forms

      cursorRequest.<span class="hljs-function"><span class="hljs-title">onsuccess</span> = <span class="hljs-params">(e)</span> -&gt;</span>
        result = e.target.result
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> result
          <span class="hljs-keyword">return</span>
        forms.push result.value
        result.<span class="hljs-keyword">continue</span>()

      cursorRequest.onerror = <span class="hljs-property">@onerror</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Create a new form item.
  @param {object} formObject The form data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">createForm</span>: <span class="hljs-function"><span class="hljs-params">(formObject, callback)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Get a reference to the db.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      db = <span class="hljs-property">@datastore</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Initiate a new transaction.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      transaction = db.transaction [<span class="hljs-string">'forms'</span>], <span class="hljs-string">'readwrite'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Get the datastore.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      objStore = transaction.objectStore <span class="hljs-string">'forms'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Create a timestamp for the form item.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      timestamp = <span class="hljs-keyword">new</span> Date().getTime()</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Create an object for the form item.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      formObject.timestamp = timestamp
      formObject.id = <span class="hljs-property">@guid</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Create the datastore request.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      request = objStore.put formObject, formObject.id</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Handle a successful datastore put.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      request.<span class="hljs-function"><span class="hljs-title">onsuccess</span> = <span class="hljs-params">(e)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Execute the callback function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        callback formObject</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Handle errors.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      request.onerror = <span class="hljs-property">@onerror</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Delete a form item.
  @param {int} id The timestamp (id) of the form item to be deleted.
  @param {function} callback A callback function that will be executed if
  the delete is successful.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">deleteForm</span>: <span class="hljs-function"><span class="hljs-params">(id, callback)</span> -&gt;</span>
      db = <span class="hljs-property">@datastore</span>
      transaction = db.transaction [<span class="hljs-string">'forms'</span>], <span class="hljs-string">'readwrite'</span>
      objStore = transaction.objectStore <span class="hljs-string">'forms'</span>
      request = objStore.<span class="hljs-keyword">delete</span> id

      request.<span class="hljs-function"><span class="hljs-title">onsuccess</span> = <span class="hljs-params">(e)</span> -&gt;</span>
        callback()

      request.<span class="hljs-function"><span class="hljs-title">onerror</span> = <span class="hljs-params">(e)</span> -&gt;</span>
        <span class="hljs-built_in">console</span>.log e</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>General error handler</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">onerror</span>:<span class="hljs-function"> -&gt;</span>
      <span class="hljs-built_in">console</span>.log <span class="hljs-string">'Generic LingSyncIDB error method called'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Delete entire indexedDB database.
FIXME: this messes up the indexedDB database in ways I don’t understand…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">deleteDatabase</span>: <span class="hljs-function"><span class="hljs-params">(callback)</span> -&gt;</span>
      <span class="hljs-keyword">try</span>
        request = <span class="hljs-property">@indexedDB</span>.deleteDatabase <span class="hljs-property">@id</span>
        request.<span class="hljs-function"><span class="hljs-title">onsuccess</span> = <span class="hljs-params">(event)</span> -&gt;</span>
          db = event.result
          callback <span class="hljs-literal">true</span>
        request.<span class="hljs-function"><span class="hljs-title">onerror</span> = <span class="hljs-params">(event)</span> -&gt;</span>
          <span class="hljs-built_in">console</span>.error <span class="hljs-string">"indexedDB.delete Error: <span class="hljs-subst">#{event.message}</span>"</span>
          callback <span class="hljs-literal">false</span>
      <span class="hljs-keyword">catch</span> e
        <span class="hljs-built_in">console</span>.error <span class="hljs-string">"Error: <span class="hljs-subst">#{e.message}</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>prefer change id of database than to start on new instance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@id</span> = <span class="hljs-property">@id</span> + <span class="hljs-string">'.'</span> + <span class="hljs-property">@guid</span>()
        callback <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
